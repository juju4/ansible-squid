{{ ansible_managed | comment }}

# Example rule allowing access from your local networks.
# Adapt to list your (internal) IP networks from where browsing
# should be allowed
acl localnet src 10.0.0.0/8    # RFC1918 possible internal network
#acl localnet src 172.16.0.0/12 # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
#acl localnet src fc00::/7       # RFC 4193 local private network range
#acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80          # http
#acl Safe_ports port 21         # ftp
acl Safe_ports port 443         # https
#acl Safe_ports port 70         # gopher
acl Safe_ports port 1025-65535  # unregistered ports
acl CONNECT method CONNECT
{% if not (ansible_os_family == "RedHat" and ansible_distribution_version.split('.')[0] == '7') %}
acl localhost src 127.0.0.1/32
{% endif %}
{% for client in squid_allowed_clients %}
acl allowed_clients src {{ client }}
{% endfor %}

http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

cache_mgr {{ squid_cache_admin_email }}

# Suppress Squid version string info in HTTP headers and HTML error pages. = not valid/bungled(3.5.12)
#httpd_suppress_version_string
# Limit the size of acceptable HTTP headers.
request_header_max_size 64 KB
ignore_unknown_nameservers on

# Disable ICP and HTCP (communication with other caches)
icp_port 0
icp_access deny all
htcp_port 0
htcp_access deny all
snmp_port 0
snmp_access deny all

# Tuning
pipeline_prefetch 1
shutdown_lifetime 5 second

# own templates? http://www.squid-cache.org/Doc/config/error_directory/
#		 http://blog.squidblacklist.org/?p=707
#error_directory /path/to

{% if not (ansible_os_family == "RedHat" and ansible_distribution_version.split('.')[0] == '6') %}
# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

{% endif %}
# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on "localhost" is a local user
#http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

{% if squid_filter_ads is defined and squid_filter_ads %}
## disable ads ( http://pgl.yoyo.org/adservers/ )
acl ads dstdom_regex "{{ squid_confdir }}/ad_block.txt"
http_access deny ads
#deny_info TCP_RESET ads

{% endif %}

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
{% if not squid_testing %}
http_access allow localhost
{% endif %}
{% if squid_allowed_clients != [] %}
http_access allow allowed_clients
{% endif %}

{% if squid_splash_enable is defined and squid_splash_enable %}
# https://wiki.squid-cache.org/ConfigExamples/Portal/Splash
# https://thejimmahknows.com/squid-proxy-splash-page-2/
# https://github.com/tombatossals/squid_guifi_splash
# -t <idle_timeout>
# -T <fixed_timeout>
{% if ansible_os_family == "RedHat" %}
external_acl_type splash_page ttl=60 concurrency=100 %SRC /usr/lib64/squid/ext_session_acl -t 7200 -b /var/lib/squid/session.db
{% else %}
external_acl_type splash_page ttl=60 concurrency=100 %SRC /usr/lib/squid/ext_session_acl -t 7200 -b /var/lib/squid/session.db
{% endif %}

acl existing_users external splash_page

#deny_info 511:/etc/squid/splash.html existing_users
deny_info {{ squid_splash_url }}?url=%s existing_users

http_access deny !existing_users

{% endif %}
# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
{% if not squid_https %}
http_port 3128
{% else %}
http_port 3128
{# Only redhat with openssl support, latest debian/ubuntu with gnutls but mising cert generators #}
{% if ansible_os_family == "RedHat" %}
# https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit
http_port 3129 ssl-bump \
  key={{ ssl_privatedir }}/{{ ansible_fqdn }}.key \
  cert={{ ssl_dir }}/{{ ansible_fqdn }}.crt \
  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

sslcrtd_program /usr/lib64/squid/ssl_crtd \
  -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

acl step1 at_step SslBump1

ssl_bump peek step1
ssl_bump bump all

#sslproxy_cafile /usr/local/openssl/cabundle.file

sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE

sslproxy_cipher EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS

{% elif ansible_distribution == "Ubuntu" and squid_https %}
#squid-4 only

sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s /var/lib/ssl_db -M 4MB
#tls_outgoing_options cafile=/usr/local/openssl/cabundle.file

tls_outgoing_options options=NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE

{% endif %}

# troubleshooting
sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER

# http://www.squid-cache.org/Doc/config/https_port/
# https://wiki.squid-cache.org/Features/HTTPS
#https_port 3129 tls-min-version=1.2
{% endif %}

# Leave coredumps in the first cache dir
coredump_dir {{ squid_spool }}

{% if squid_log_querystrings is defined and squid_log_querystrings %}
# Do you want to keep query strings? have privacy consequence.
strip_query_terms off
{% endif %}

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
#refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
# example lin deb packages
#refresh_pattern (\.deb|\.udeb)$   129600 100% 129600
refresh_pattern .               0       20%     4320

# ANONYMOUS/Privacy PROXY
# (but Via off will generate Warning at each start...)
via off
# http://www.squid-cache.org/Doc/config/forwarded_for/
forwarded_for delete
request_header_access Allow allow all
request_header_access Authorization allow all
request_header_access WWW-Authenticate allow all
request_header_access Proxy-Authorization allow all
request_header_access Proxy-Authenticate allow all
request_header_access Cache-Control allow all
request_header_access Content-Encoding allow all
request_header_access Content-Length allow all
request_header_access Content-Type allow all
request_header_access Date allow all
request_header_access Expires allow all
request_header_access Host allow all
request_header_access If-Modified-Since allow all
request_header_access Last-Modified allow all
request_header_access Location allow all
request_header_access Pragma allow all
#request_header_access Accept allow all
header_replace 	      Accept */*
request_header_access Accept-Charset allow all
#request_header_access Accept-Encoding allow all
header_replace        Accept-Encoding         *
request_header_access Accept-Language allow all
request_header_access Content-Language allow all
request_header_access Mime-Version allow all
request_header_access Retry-After allow all
request_header_access Title allow all
request_header_access Connection allow all
request_header_access Proxy-Connection allow all
request_header_access User-Agent allow all
#header_replace        User-Agent OurBrowser/1.0 (Some Name)
request_header_access Cookie allow all
request_header_access Server deny all
request_header_access All deny all
{% if squid_urlfiltering_tool == 'dansguardian' %}
{# http://squid.sourceforge.net/follow_xff/ #}
{# https://gist.github.com/alvarow/fa409edc70aeb4cf89bbc83c1c78f392 #}
follow_x_forwarded_for allow localhost
acl_uses_indirect_client on
delay_pool_uses_indirect_client on
log_uses_indirect_client on
{% else %}
follow_x_forwarded_for deny all
{% endif %}

# Cache (mostly for deb/rpm)
## maximum_object_size should be before cache_dir
## http://squid-web-proxy-cache.1019090.n4.nabble.com/Problem-with-caching-larger-files-td4666004.html#a4666006
## https://tails.boum.org/contribute/build/squid-deb-proxy/squid-deb-proxy.conf
maximum_object_size 1 GB
#cache_dir ufs {{ squid_spool }} 100 16 256
cache_dir ufs {{ squid_spool }} 70000 16 256
cache_replacement_policy heap LFUDA
refresh_pattern deb$           129600 100%     129600
refresh_pattern udeb$          129600 100%     129600
refresh_pattern tar.gz$        129600 100%     129600
refresh_pattern DiffIndex$      0       20%     4320 refresh-ims
refresh_pattern PackagesIndex$  0       20%     4320 refresh-ims
refresh_pattern Packages\.bz2$  0       20%     4320 refresh-ims
refresh_pattern Packages\.gz$   0       20%     4320 refresh-ims
refresh_pattern Packages\.lzma$ 0       20%     4320 refresh-ims
refresh_pattern SourcesIndex$   0       20%     4320 refresh-ims
refresh_pattern Sources\.bz2$   0       20%     4320 refresh-ims
refresh_pattern Sources\.gz$    0       20%     4320 refresh-ims
refresh_pattern Sources\.lzma$  0       20%     4320 refresh-ims
refresh_pattern Release$        0       20%     4320 refresh-ims
refresh_pattern Release\.gpg$   0       20%     4320 refresh-ims
refresh_pattern Translation-en\.bzip2$ 0       20%     4320 refresh-ims
refresh_pattern Translation-en\.bz2$   0       20%     4320 refresh-ims
refresh_pattern Translation-en\.gz$    0       20%     4320 refresh-ims
refresh_pattern Translation-en\.lzma$  0       20%     4320 refresh-ims
refresh_pattern Translation-fr\.bzip2$ 0       20%     4320 refresh-ims
refresh_pattern Translation-fr\.bz2$   0       20%     4320 refresh-ims
refresh_pattern Translation-fr\.gz$    0       20%     4320 refresh-ims
refresh_pattern Translation-fr\.lzma$  0       20%     4320 refresh-ims
#refresh_pattern -i .rpm$ 	129600 	100%	129600 refresh-ims override-expire
#refresh_pattern -i .iso$ 	129600 	100% 	129600 refresh-ims override-expire
refresh_pattern -i .rpm$ 	129600 	100%	129600 refresh-ims
refresh_pattern -i .iso$ 	129600 	100% 	129600 refresh-ims
refresh_pattern .               0       20%     4320

# handle meta-release and changelogs.ubuntu.com special
refresh_pattern changelogs.ubuntu.com/*  0  1% 1

# see https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=499379
refresh_all_ims on

## direct access?
#acl local-servers dstdomain my.domain.net
#always_direct allow local-servers
#acl FTP proto FTP
#always_direct allow FTP

## Customize logging
## http://www.squid-cache.org/Doc/config/logformat/
logformat customlogformat %tl %>a "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:Sh
access_log {{ squid_customlog_path }} customlogformat
# human-readable time?
#logformat squid %tg.%03tu %6tr %>a %Ss/%03Hs %

{% if squid_urlfiltering_enable is defined and squid_urlfiltering_enable and squid_urlfiltering_tool == 'squidguard' %}
url_rewrite_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf

{% endif %}

# https://www.edv-huber.com/index.php/problemloesungen/22-squid-proxy-server-filter-urls-by-virustotal-com
# https://blog.rootshell.be/2014/12/15/automatic-mime-parts-scanning-with-virustotal/

# debug
#debug_options ALL,1 33,2 28,9
